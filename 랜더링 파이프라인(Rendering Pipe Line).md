# 렌더링 파이프라인(Rendering Pipe Line)



아래의 내용은 렌더링 파이프라인(Rendering Pipe Line)에 대해 공부한 내용을 정리한 것입니다.

* **렌더링 파이프라인이란**
  * GPU가 정점 정보와 텍스처 데이터를 연산해서 각 픽셀의 컬러값을 출력하는 공정이다.
  * 스크린에 이미지를 그리기 위한 일련의 과정과 사용되는 기술을 통틀어 렌더링 파이프라인이라고 한다.



* **종류**

  유니티 2018 부터 기존에 있던 렌더링 파이프라인을 대체하기 위해 새로운 파이프라인 개념 SRP(Scripatable Rendering Pipeline) 을 제시했는데,  이를 사용해서 라이팅 처리 방식을 포함한 전반적인 렌더링 루프를 직접 구성할 수 있습니다.  이러한 기능들을 C# 스크립트로 사용하고 제어할 수 있도록 되어 있습니다. 유니티를 사용하는 개발자는 C# 스크립트로 자신만의 렌더 루프를 만들 수 있습니다. 그렇지만,  SRP를 통해서 파이프라인을 구성하는 것은 많은 지식, 능력, 작업이 필요합니다. 따라서 유니티에서는 SRP로 직접 파이프라인을 구성하지 않고 HDRP, LWRP를 이용해서 프로젝트를 진행할 수 있습니다.

  * HDRP(High Definition Redering Pipeline)

    * 하이엔드 PC나 콘솔등을 고려해서 구현하는데 적합한 파이프라인으로, 높은 퀄리티를 낼 수 있게 최적화된 렌더링 파이프라인.

    * 모바일이나 저사양 기기에는 적합하지 않음. 

  * LWRP (Lightweight Rendering Pipeline)

    * 모바일 플랫폼에서도 사용이 가능하며, 고화질로 빠르게 렌더링하기 위해 최적화된 렌더링 파이프라인이다.
    * VR 작업을 위한 프리셋이 제공된다.

  * **Sample**

     데모 및 기본적인 샘플들이다.

    * <https://blogs.unity3d.com/kr/2018/10/24/introducing-the-fps-sample/> 

    *  https://github.com/Unity-Technologies/ScriptableRenderPipeline

      

* **구성**

  ![Stage](C:\Users\strip\Desktop\Github\렌더링파이프라인\Stage.PNG)

  * **입력 어셈블러 스테이지(고정처리)**

    메모리에 배치된 메시의 정상 데이터가 GPU에 송신되면 먼저 이 입력 어셈블러 스테이지에서 GPU가 처리하기 쉬운 형식으로 변환합니다.

    보내온 정점 데이터는 모든 정점 좌표로 구성되는 **정점 리스트**와 각각의 정점 좌표가 어떻게 폴리곤을 형성할지 나타내는 **정점 인덱스**라는 두 개의 데이터로부터 구성됩니다. 

    이 스테이지에서는 위의 두가지 데이터로부터 **프리미티브**라는 정보를 생성하고 다음 스테이지로 보냅니다.

  * **정점 셰이더 스테이지**

    정점 셰이더 스테이지에서는 프리미티브를 구성하는 정점의 좌표를 하나하나씩 받고, 적절하게 좌표 변환 후 다음 스테이지로 전달합니다.

  * **컬링 스테이지(고정처리)**

    **컬링**은 카메라에 대해서 뒤집혀 있는 프리미티브 처리를 건너뛰는 처리입니다. 

    씬에 있는 모든 폴리곤을 매 프레임마다 연산하게 된다면, GPU 리소스가 아무리 많아도 부족하게 됩니다. 따라서 렌더링 축소는 꼭해야 합니다.

    컬링은 고정 처리이므로 자동으로 실행되지만, ShaderLab으로 제어가 가능합니다. 

  * **래스터라이저 스테이지(고정처리)**

    래스터라이저 스테이지에서는 정점 셰이더로부터 출력된 프리미티브 1개의 클립 공간 좌표(3개의 좌표)로부터 그 좌표가 구성하는 삼각형 포함되는 전체 픽셀의 좌표 정보를 생성합니다. 이 하나하나가 결국 화면에 표시되는 픽셀입니다.

    좌표 정보는 세 점의 정점 좌표로부터 선형 보간에 따라 생성됩니다.

    <https://ko.wikipedia.org/wiki/%EC%84%A0%ED%98%95_%EB%B3%B4%EA%B0%84%EB%B2%95>

  * **출력 머더 스테이지(고정처리)**

    출력 머더 스테이지는 픽셀에 대해서 심도 테스트(픽셀에 더 가까운 프리미티브 확인), 스텐실 테스트(스텐실 버퍼 사용 처리), 알파 테스트(투명 설정 색상 삭제)를 시행하고, 픽셀을 화면에 반영할지 여부를 판정합니다.

    위의 테스트에 합격한 픽셀은 블렌딩이라는 처리가 이루어집니다.

    이후 프레임 버퍼에 컬러값이 쓰입니다. 모든 프리미티브에 대해 처리가 실행된 다음, 프레임 버퍼가 스크린에 전송되고 화면이 갱신됩니다.

    

* 참고자료

  * 유니티 게임 프로그래밍 바이블 
  * 각종 구글 자료

  



